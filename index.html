<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCY C30 Monitor</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f8f9fa; color: #333; }
        h1 { margin-bottom: 30px; font-size: 1.5rem; }
        
        /* ボタンのデザイン */
        button { 
            font-size: 1rem; padding: 12px 24px; 
            background: #007bff; color: white; 
            border: none; border-radius: 50px; 
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,123,255,0.3);
            transition: all 0.2s;
        }
        button:hover { background: #0056b3; transform: translateY(-2px); }
        button:disabled { background: #ccc; transform: none; box-shadow: none; }

        /* バッテリー表示エリア */
        .battery-container { 
            display: flex; justify-content: center; gap: 20px; margin-top: 40px; 
            opacity: 0.5; transition: opacity 0.5s; /* 初期は薄くする */
        }
        .battery-container.active { opacity: 1; }

        .battery-box { 
            background: white; padding: 25px 15px; 
            border-radius: 20px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); 
            width: 110px; position: relative;
        }

        .label { font-size: 0.9rem; font-weight: bold; color: #888; display: block; margin-bottom: 5px; }
        .value { font-size: 2.2rem; font-weight: bold; color: #333; }
        .unit { font-size: 1rem; color: #888; margin-left: 2px; }

        /* バッテリー残量による色変化用クラス */
        .high { color: #28a745; } /* 緑 */
        .mid  { color: #ffc107; } /* 黄 */
        .low  { color: #dc3545; } /* 赤 */

        #status { margin-top: 20px; font-size: 0.9rem; color: #666; height: 1.2em; }
    </style>
</head>
<body>

    <h1>QCY C30 バッテリーモニター</h1>
    <button id="connectBtn">デバイスに接続</button>
    <div id="status">未接続</div>

    <div class="battery-container" id="displayArea">
        <div class="battery-box">
            <span class="label">Left</span>
            <span id="bat-L" class="value">--</span><span class="unit">%</span>
        </div>
        <div class="battery-box">
            <span class="label">Right</span>
            <span id="bat-R" class="value">--</span><span class="unit">%</span>
        </div>
    </div>

    <script>
        const SERVICE_UUID = '0000a001-0000-1000-8000-00805f9b34fb';
        const CHAR_UUID    = '00000008-0000-1000-8000-00805f9b34fb';

        const btn = document.getElementById('connectBtn');
        const statusDiv = document.getElementById('status');
        const displayArea = document.getElementById('displayArea');

        // 色を変えるヘルパー関数
        function updateColor(elementId, percent) {
            const el = document.getElementById(elementId);
            el.className = 'value'; // クラスをリセット
            if (percent > 50) { el.classList.add('high'); }
            else if (percent > 20) { el.classList.add('mid'); }
            else { el.classList.add('low'); }
        }

        btn.addEventListener('click', async () => {
            try {
                statusDiv.innerText = "デバイスを検索中...";
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                statusDiv.innerText = "接続中...";
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                const characteristic = await service.getCharacteristic(CHAR_UUID);

                // 読み取り処理
                const updateBattery = async () => {
                    const value = await characteristic.readValue();
                    const left = value.getUint8(0);
                    const right = value.getUint8(1);

                    document.getElementById('bat-L').innerText = left;
                    document.getElementById('bat-R').innerText = right;

                    // 色の更新
                    updateColor('bat-L', left);
                    updateColor('bat-R', right);
                    
                    statusDiv.innerText = "接続済み";
                    displayArea.classList.add('active'); // 表示を明るくする
                };

                // 初回実行
                await updateBattery();

                // リアルタイム更新（通知）の設定
                try {
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', async (event) => {
                        const val = event.target.value;
                        const l = val.getUint8(0);
                        const r = val.getUint8(1);
                        document.getElementById('bat-L').innerText = l;
                        document.getElementById('bat-R').innerText = r;
                        updateColor('bat-L', l);
                        updateColor('bat-R', r);
                    });
                } catch(e) {
                    console.log("通知非対応");
                }

                btn.innerText = "接続済み";
                btn.disabled = true;

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "キャンセルされました、または接続エラー";
            }
        });
    </script>
</body>
</html>
